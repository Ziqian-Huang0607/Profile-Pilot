<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile-Pilot | AI GitHub Analyzer</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Profile-Pilot ‚úàÔ∏è</h1>
        <p>Enter a GitHub username to generate an AI-powered analysis.</p>
    </header>
    <main>
        <div class="input-form">
            <input type="text" id="usernameInput" placeholder="e.g., torvalds, gaeron">
            <button id="analyzeBtn">Analyze</button>
        </div>
        
        <div id="resultsContainer">
            <div id="loader" class="hidden"></div>
            <div id="actionsContainer" class="hidden">
                <button id="copyBtn">üìã Copy to Clipboard</button>
                <button id="downloadBtn">‚¨áÔ∏è Download as Markdown</button>
            </div>
            <div id="report"></div>
        </div>
    </main>

    <script>
        // Get references to all the interactive elements on the page
        const analyzeBtn = document.getElementById('analyzeBtn');
        const usernameInput = document.getElementById('usernameInput');
        const resultsContainer = document.getElementById('resultsContainer');
        const loader = document.getElementById('loader');
        const reportDiv = document.getElementById('report');
        const actionsContainer = document.getElementById('actionsContainer');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // State variables to hold data between actions
        let rawMarkdownReport = '';
        let currentUsername = '';

        // Main function to handle the analysis process
        const handleAnalysis = async () => {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('Please enter a GitHub username.');
                return;
            }

            // --- 1. PREPARE UI FOR A NEW ANALYSIS ---
            loader.classList.remove('hidden'); // Show spinner
            actionsContainer.classList.add('hidden'); // Hide buttons
            reportDiv.innerHTML = ''; // Clear previous report
            rawMarkdownReport = ''; // Clear old markdown data
            currentUsername = username; // Store username for download filename

            try {
                // --- 2. CALL THE BACKEND API ---
                // Ensure this URL points to YOUR Vercel deployment
                const apiUrl = `https://profile-pilot-seven.vercel.app/api/index?username=${username}`;
                
                const response = await fetch(apiUrl);
                
                // The 'await response.json()' part is important. It reads the entire
                // response body and parses it as JSON.
                const data = await response.json();

                // Check if the response from the server was successful.
                // A successful response has a status code in the 200-299 range.
                if (!response.ok) {
                    // If the server responded with an error status (like 500),
                    // the 'data' object will likely contain an 'error' key.
                    // We throw an error here to jump to the 'catch' block below.
                    throw new Error(data.error || `Request failed with status ${response.status}`);
                }
                
                // --- 3. VALIDATE AND DISPLAY THE REPORT ---
                // This is the crucial defensive check. We verify that the 'data' object
                // we received is valid and contains the 'report_html' key we need.
                if (data && data.report_html) {
                    // Success! The data is in the expected format.
                    rawMarkdownReport = data.report_md;      // Store the raw markdown
                    reportDiv.innerHTML = data.report_html;   // Display the formatted HTML
                    actionsContainer.classList.remove('hidden'); // Show the action buttons
                } else {
                    // The server responded with status 200 (OK), but the data object
                    // was empty or malformed. We throw a clear error for this case.
                    throw new Error('The server returned an invalid or empty response.');
                }

            } catch (error) {
                // This 'catch' block handles ALL errors: network failures, server errors,
                // and the validation errors we threw ourselves.
                reportDiv.innerHTML = `<p class="error">Failed to generate report. <br><small>Details: ${error.message}</small></p>`;
            } finally {
                // This 'finally' block always runs, ensuring the loader is hidden
                // whether the analysis succeeded or failed.
                loader.classList.add('hidden');
            }
        };

        // --- JAVASCRIPT FOR ACTION BUTTONS ---

        // Function to copy the raw markdown report to the clipboard
        const copyToClipboard = () => {
            if (!rawMarkdownReport) return;
            navigator.clipboard.writeText(rawMarkdownReport).then(() => {
                copyBtn.innerText = '‚úÖ Copied!';
                setTimeout(() => { copyBtn.innerText = 'üìã Copy to Clipboard'; }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Could not copy text.');
            });
        };

        // Function to trigger a download of the report as a .md file
        const downloadAsMarkdown = () => {
            if (!rawMarkdownReport) return;
            const blob = new Blob([rawMarkdownReport], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); // Create a temporary link element
            a.href = url;
            a.download = `${currentUsername}_profile_pilot_report.md`; // Set the filename
            document.body.appendChild(a); // Add the link to the page
            a.click(); // Programmatically click the link to start the download
            document.body.removeChild(a); // Clean up by removing the link
            URL.revokeObjectURL(url); // Free up memory
        };

        // --- Add event listeners to trigger the functions ---
        analyzeBtn.addEventListener('click', handleAnalysis);
        
        usernameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                handleAnalysis();
            }
        });
        
        copyBtn.addEventListener('click', copyToClipboard);
        downloadBtn.addEventListener('click', downloadAsMarkdown);
    </script>
</body>
</html>
