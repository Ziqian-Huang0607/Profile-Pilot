<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile-Pilot | AI GitHub Analyzer</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Profile-Pilot ‚úàÔ∏è</h1>
        <p>Enter a GitHub username to generate an AI-powered analysis.</p>
    </header>
    <main>
        <div class="input-form">
            <input type="text" id="usernameInput" placeholder="e.g., torvalds, gaeron">
            <button id="analyzeBtn">Analyze</button>
        </div>
        
        <div id="resultsContainer">
            <div id="loader" class="hidden"></div>
            <!-- NEW: Container for action buttons -->
            <div id="actionsContainer" class="hidden">
                <button id="copyBtn">üìã Copy to Clipboard</button>
                <button id="downloadBtn">‚¨áÔ∏è Download as Markdown</button>
            </div>
            <div id="report"></div>
        </div>
    </main>

    <script>
        // Get references to all elements
        const analyzeBtn = document.getElementById('analyzeBtn');
        const usernameInput = document.getElementById('usernameInput');
        const resultsContainer = document.getElementById('resultsContainer');
        const loader = document.getElementById('loader');
        const reportDiv = document.getElementById('report');
        // NEW: Get references to new buttons
        const actionsContainer = document.getElementById('actionsContainer');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // NEW: A variable to store the raw markdown report
        let rawMarkdownReport = '';
        let currentUsername = ''; // To store the username for the filename

        const handleAnalysis = async () => {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('Please enter a GitHub username.');
                return;
            }

            // --- 1. PREPARE UI FOR LOADING ---
            loader.classList.remove('hidden');
            actionsContainer.classList.add('hidden'); // Hide buttons during load
            reportDiv.innerHTML = '';
            rawMarkdownReport = ''; // Clear old markdown
            currentUsername = username; // Store username for download

            try {
                // --- 2. CALL BACKEND API ---
                // IMPORTANT: Ensure this URL is correct!
                const apiUrl = `https://profile-pilot-seven.vercel.app/api/index?username=${username}`;
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // NEW: Expecting { report_html, report_md } from the backend now
                const data = await response.json();
                
                // --- 3. DISPLAY THE REPORT & STORE DATA ---
                rawMarkdownReport = data.report_md; // Store the raw markdown
                reportDiv.innerHTML = data.report_html; // Display the formatted HTML
                actionsContainer.classList.remove('hidden'); // Show the action buttons

            } catch (error) {
                reportDiv.innerHTML = `<p class="error">Failed to generate report. <br><small>Details: ${error.message}</small></p>`;
            } finally {
                loader.classList.add('hidden');
            }
        };

        // --- NEW: JAVASCRIPT FOR ACTION BUTTONS ---

        // Function to copy text to the clipboard
        const copyToClipboard = () => {
            if (!rawMarkdownReport) return;
            navigator.clipboard.writeText(rawMarkdownReport).then(() => {
                copyBtn.innerText = '‚úÖ Copied!';
                setTimeout(() => { copyBtn.innerText = 'üìã Copy to Clipboard'; }, 2000); // Reset button text after 2 seconds
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        };

        // Function to download the report as a .md file
        const downloadAsMarkdown = () => {
            if (!rawMarkdownReport) return;
            const blob = new Blob([rawMarkdownReport], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentUsername}_profile_pilot_report.md`; // e.g., torvalds_profile_pilot_report.md
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // --- Add event listeners ---
        analyzeBtn.addEventListener('click', handleAnalysis);
        usernameInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') { handleAnalysis(); }
        });
        // NEW: Add listeners for the new buttons
        copyBtn.addEventListener('click', copyToClipboard);
        downloadBtn.addEventListener('click', downloadAsMarkdown);
    </script>
</body>
</html>
